# Gu√≠a de Despliegue Paso a Paso - ETL Movilidad Medell√≠n

Esta gu√≠a te llevar√° paso a paso desde cero hasta tener el sistema funcionando.

## üìã Pre-requisitos

Antes de empezar, necesitas:

1. **Python 3.9 o superior**
   - Verificar: `python --version`
   - Descargar: https://www.python.org/downloads/

2. **Cuenta de Google Cloud**
   - Crear cuenta: https://console.cloud.google.com
   - Necesitar√°s tarjeta de cr√©dito (pero hay free tier)

3. **Editor de texto**
   - VS Code (recomendado): https://code.visualstudio.com/
   - O cualquier editor de texto

## üöÄ Paso 1: Configurar Google Cloud (15 minutos)

### 1.1. Crear proyecto

1. Ve a https://console.cloud.google.com
2. Click en "Select a project" ‚Üí "NEW PROJECT"
3. Nombre: `etl-movilidad-medellin`
4. Click "CREATE"
5. **Anota el Project ID** (ej: `etl-movilidad-medellin-12345`)

### 1.2. Habilitar Vertex AI API

1. En la consola de Google Cloud, busca "Vertex AI API"
2. Click en "ENABLE"
3. Espera 1-2 minutos

### 1.3. Instalar gcloud CLI

**Windows:**
1. Descargar: https://cloud.google.com/sdk/docs/install
2. Ejecutar instalador
3. Abrir nueva terminal PowerShell

**macOS:**
```bash
brew install google-cloud-sdk
```

**Linux:**
```bash
curl https://sdk.cloud.google.com | bash
exec -l $SHELL
```

### 1.4. Autenticar y configurar

```bash
# Autenticar
gcloud auth login

# Configurar proyecto (reemplazar con tu Project ID)
gcloud config set project etl-movilidad-medellin-12345

# Autenticar para aplicaciones
gcloud auth application-default login
```

‚úÖ **Checkpoint**: Verifica que todo funciona:
```bash
gcloud projects describe etl-movilidad-medellin-12345
```

## üõ†Ô∏è Paso 2: Instalar el proyecto (10 minutos)

### 2.1. Navegar al directorio

```bash
# Ir al directorio del proyecto
cd etl-movilidad-local
```

### 2.2. Crear entorno virtual

**Windows:**
```bash
python -m venv venv
venv\Scripts\activate
```

**macOS/Linux:**
```bash
python3 -m venv venv
source venv/bin/activate
```

Deber√≠as ver `(venv)` en tu terminal.

### 2.3. Instalar dependencias

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

Esto instalar√°:
- google-cloud-aiplatform
- vertexai
- requests
- feedparser
- beautifulsoup4
- schedule
- python-dotenv

‚úÖ **Checkpoint**: Verifica instalaci√≥n:
```bash
pip list | grep google
```

Deber√≠as ver `google-cloud-aiplatform` y otros paquetes de Google.

## ‚öôÔ∏è Paso 3: Configurar variables de entorno (5 minutos)

### 3.1. Crear archivo .env

```bash
# Copiar ejemplo
cp .env.example .env
```

### 3.2. Editar .env

Abrir `.env` con tu editor y modificar:

```env
# Reemplazar con tu Project ID
GOOGLE_CLOUD_PROJECT=etl-movilidad-medellin-12345

# Regi√≥n (dejar por defecto)
VERTEX_AI_LOCATION=us-central1

# Usar ADK real (no mock)
USE_MOCK_ADK=false

# Ejecutar cada 5 minutos
SCHEDULE_INTERVAL_MINUTES=5

# Alertas por email (opcional, dejar false por ahora)
ENABLE_EMAIL_ALERTS=false
```

**Importante:** Guarda el archivo despu√©s de editar.

‚úÖ **Checkpoint**: Verifica que .env existe y tiene tu Project ID:
```bash
cat .env | grep GOOGLE_CLOUD_PROJECT
```

## üß™ Paso 4: Probar extracci√≥n (5 minutos)

Antes de ejecutar el pipeline completo, probemos solo la extracci√≥n:

```bash
cd scripts
python test_extraction.py
```

**Resultado esperado:**
```
============================================================
Testing News Extraction
============================================================

--- Testing Metro de Medell√≠n RSS ---
‚úì Extracted 15 news items

Sample (first item):
{
  "source": "Metro de Medell√≠n",
  "url": "https://...",
  "title": "...",
  ...
}
...
Total extracted: 45 news items
```

Si ves errores:
- Verifica conexi√≥n a internet
- Las URLs de fuentes pueden haber cambiado (es normal, se puede ajustar)

## üéØ Paso 5: Primera ejecuci√≥n (MOMENTO DE VERDAD!)

### 5.1. Ejecutar pipeline manualmente

```bash
cd ../src
python main.py
```

**Qu√© esperar:**

```
============================================================
Starting ETL Pipeline execution
============================================================
STEP 1: Extracting news from sources...
‚úì Extracted 42 news items

STEP 2: Deduplicating news...
‚úì Deduplicated: 0 duplicates found, 42 unique items

STEP 3: Scoring news with ADK...
[Llamadas a Gemini API aqu√≠...]
‚úì Scored 42 items: 15 kept, 27 discarded

STEP 4: Saving to database...
‚úì Saved 15 news items to database

STEP 5: Sending alerts for high severity news...
‚ö†Ô∏è ALERTA DE MOVILIDAD - HIGH
============================================================
T√≠tulo: Cierre de v√≠a en Medell√≠n...
...
‚úì Sent 3 alerts

============================================================
ETL Pipeline execution complete
Duration: 45.23 seconds
============================================================
```

### 5.2. Si hay errores

**Error: "DefaultCredentialsError"**
```bash
gcloud auth application-default login
```

**Error: "API not enabled"**
```bash
gcloud services enable aiplatform.googleapis.com
```

**Error: "Permission denied"**
- Verifica que tu cuenta tiene permisos de Vertex AI
- En console.cloud.google.com ‚Üí IAM ‚Üí Agregar role "Vertex AI User"

### 5.3. Modo de prueba sin Google Cloud

Si quieres probar sin API calls:

1. Editar `.env`: `USE_MOCK_ADK=true`
2. Ejecutar: `python main.py`

Esto usa clasificaci√≥n simple sin llamar a Gemini.

## üìä Paso 6: Verificar resultados (5 minutos)

### 6.1. Ver estad√≠sticas

```bash
cd ../scripts
python db_stats.py
```

Ver√°s:
- Total de noticias guardadas
- Distribuci√≥n por severidad
- Distribuci√≥n por fuente
- √öltimas noticias

### 6.2. Ver alertas

```bash
python view_alerts.py
```

Ver√°s todas las alertas enviadas con detalles.

### 6.3. Explorar base de datos

La base de datos SQLite est√° en `data/etl_movilidad.db`

Puedes abrirla con:
- DB Browser for SQLite: https://sqlitebrowser.org/
- DBeaver: https://dbeaver.io/

## ‚è∞ Paso 7: Configurar ejecuci√≥n autom√°tica (5 minutos)

### 7.1. Ejecutar scheduler

```bash
cd ../src
python scheduler.py
```

Esto ejecutar√° el pipeline:
1. Inmediatamente al iniciar
2. Luego cada 5 minutos (configurable en `.env`)

**Salida esperada:**
```
============================================================
ETL Scheduler Starting
============================================================
Interval: Every 5 minutes
Mock ADK: False
Email Alerts: False
Press Ctrl+C to stop
============================================================

Running initial pipeline execution...
[Pipeline ejecuta...]

Scheduler running. Waiting for next execution...
[Espera 5 minutos...]
[Pipeline ejecuta nuevamente...]
```

### 7.2. Detener scheduler

Presiona `Ctrl+C` para detener.

### 7.3. Ejecutar en segundo plano (opcional)

**Windows (PowerShell):**
```powershell
Start-Process python -ArgumentList "scheduler.py" -WindowStyle Hidden
```

**Linux/Mac:**
```bash
nohup python scheduler.py > ../logs/scheduler.log 2>&1 &
```

## üìß Paso 8: Configurar alertas por email (OPCIONAL - 10 minutos)

### 8.1. Configurar Gmail

1. Ve a https://myaccount.google.com/security
2. Habilita autenticaci√≥n de 2 factores
3. Ve a https://myaccount.google.com/apppasswords
4. Crea App Password para "Mail"
5. Anota la contrase√±a (16 caracteres)

### 8.2. Editar .env

```env
ENABLE_EMAIL_ALERTS=true
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=tu-email@gmail.com
SMTP_PASSWORD=xxxx-xxxx-xxxx-xxxx  # App Password
ALERT_RECIPIENTS=destinatario1@ejemplo.com,destinatario2@ejemplo.com
```

### 8.3. Probar

```bash
cd src
python main.py
```

Deber√≠as recibir emails para noticias de alta severidad.

## üéâ ¬°Listo! El sistema est√° funcionando

## üìù Tareas de mantenimiento

### Monitoreo diario

```bash
# Ver logs
tail -f logs/etl_pipeline.log

# Ver estad√≠sticas
cd scripts && python db_stats.py

# Ver alertas recientes
python view_alerts.py
```

### Ajustes comunes

**Cambiar intervalo de ejecuci√≥n:**
- Editar `.env`: `SCHEDULE_INTERVAL_MINUTES=15`

**Agregar m√°s fuentes:**
- Editar `src/extractors.py`
- Agregar m√©todo `extract_nueva_fuente()`
- Llamar en `extract_all()`

**Ajustar prompts de ADK:**
- Editar `src/prompts/system_prompt.py`
- Modificar criterios de relevancia
- Agregar contexto espec√≠fico

## üêõ Troubleshooting

### Problema: No se extraen noticias

**Soluci√≥n:**
1. Verificar conectividad: `curl https://www.metrodemedellin.gov.co/feed`
2. URLs pueden haber cambiado (normal)
3. Actualizar selectores en `src/extractors.py`

### Problema: ADK no clasifica bien

**Soluci√≥n:**
1. Ajustar prompts en `src/prompts/system_prompt.py`
2. Agregar m√°s ejemplos de contexto de Medell√≠n
3. Modificar criterios de relevancia

### Problema: Muchos falsos positivos/negativos

**Soluci√≥n:**
1. Ver logs: `tail -f logs/etl_pipeline.log`
2. Verificar score de relevancia en database
3. Ajustar umbral o prompts

### Problema: Costos muy altos

**Soluci√≥n:**
1. Reducir intervalo: `SCHEDULE_INTERVAL_MINUTES=15`
2. Limitar noticias por fuente en `extractors.py`
3. Verificar en Google Cloud Console ‚Üí Billing

## üìà Pr√≥ximos pasos

### Optimizaci√≥n (Semana 2-3)
- Ajustar prompts bas√°ndose en resultados reales
- Agregar m√°s fuentes
- Afinar clasificaci√≥n de severidad

### Validaci√≥n (Semana 3-4)
- Comparar con alertas oficiales
- Medir precisi√≥n y recall
- Recopilar feedback de usuarios

### Escalamiento (cuando sea necesario)
- Si volumen > 500 noticias/d√≠a
- Ver `PLAN_IMPLEMENTACION.md` para versi√≥n cloud
- Migraci√≥n gradual

## üÜò Soporte

Si encuentras problemas:

1. **Revisa logs**: `logs/etl_pipeline.log`
2. **Verifica configuraci√≥n**: `cat .env`
3. **Prueba con mock**: `USE_MOCK_ADK=true`
4. **Consulta documentaci√≥n**:
   - README.md (este directorio)
   - RESUMEN_ANALISIS_MVP.md (directorio ra√≠z)
   - PLAN_MVP_LOCAL.md (directorio ra√≠z)

## ‚úÖ Checklist de verificaci√≥n

- [ ] Google Cloud proyecto creado
- [ ] Vertex AI API habilitada
- [ ] gcloud CLI instalado y autenticado
- [ ] Entorno virtual creado y activado
- [ ] Dependencias instaladas
- [ ] Archivo .env configurado con Project ID
- [ ] Test de extracci√≥n ejecutado exitosamente
- [ ] Pipeline manual ejecutado al menos una vez
- [ ] Base de datos creada y con noticias
- [ ] Estad√≠sticas verificadas
- [ ] Scheduler probado (opcional)
- [ ] Email alerts configurados (opcional)

## üéä ¬°Felicitaciones!

Tienes un sistema ETL completo funcionando con:
- ‚úÖ Extracci√≥n autom√°tica de m√∫ltiples fuentes
- ‚úÖ Clasificaci√≥n inteligente con Google ADK
- ‚úÖ Deduplicaci√≥n autom√°tica
- ‚úÖ Alertas en tiempo real
- ‚úÖ Base de datos persistente
- ‚úÖ Ejecuci√≥n autom√°tica programada
- ‚úÖ Costo: $0.50 - $2/mes

**Duraci√≥n total de despliegue: ~1 hora**

¬°Ahora tienes un sistema de alertas de movilidad profesional para Medell√≠n! üöáüöåüöó
